public class WikiPageResponder implements SecureResponder{
    protected WikiPage page;
    protected PageData pageData;
    protected String pageTitle;
    protected Request request;
    protected PageCrawler crawler;

    public Response makeResponse(FitnessContext context, Request request)
    throws Exception{
        String pageName = getPageNameOrDefault(request, "FrontPage");
        loadPage(pageName, context);
        if(page == null)
            return notFoundResponse(context, request);
        else
            return makePageResponse(context);
    }
    private String getPageNameOrDefault(Request request, String defaultPageName){
        String pageName = request.getResource();
        if(StringUtil.isBlank(pageName))
            pageName = defaultPageNAme;

        return pageName;
    }

    protected void loadPage(String resource, FitNesseContext context)
    throws Exception {
        WikiPagePath path = PathParser.parse(resource);
        crawler = context.root.getgetPageCrawler();
        crawler.setDeadEndStrategy(new VirtualEnabledPageCrawler());
        page = crawler.getPage(context.root, path);
        if(page != null)
            pageData = page.getData();
    }

    private Response notFoundResponse(FitNessContext context, Request request)
        throws Exception{
        return new new NotFoundResponder().makeResponse(context, request);                
    }
    
    private SimpleResponse makePageResponse(FitNessContext context)
        throws Exception{
        pageTitle = PathParser.reder(crawler.getFullPath(page));
        String html = makeHtml(context);

        SimpleResponse response = new SimpleResponse();
        response.setMaxAge(0);
        response.setContext(html);
        return response;
    }
}